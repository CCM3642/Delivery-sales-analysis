<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken Delivery Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .table-row:hover {
            background-color: #f9fafb;
        }
        .btn-primary {
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        .branch-highlight {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .analysis-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .insight-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .tab-active {
            border-bottom: 3px solid #f59e0b;
            color: #f59e0b;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f8fafc;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .date-range-selector select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
        }
        .auto-offer-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #dbeafe;
            color: #1e40af;
        }
        .offer-row-normal {
            background-color: #f8d7da;
        }
        .offer-row-chicken {
            background-color: #d4edda;
        }
        .offer-row-ultimate {
            background-color: #fff3cd;
        }
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .undo-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ef4444;
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .undo-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">üçó Crispy Chicken Delivery Analytics</h1>
                    <p class="text-gray-600 mt-2">October 1-12, 2025 - Advanced Performance Analysis</p>
                </div>
                <div class="flex items-center">
                    <span id="loadingIndicator" class="loading-spinner hidden"></span>
                    <span id="updateStatus" class="text-sm text-gray-600 ml-2"></span>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex flex-wrap gap-3 mt-4">
                <select id="branchSelector" class="px-4 py-2 border-2 border-amber-500 rounded-lg font-semibold bg-white">
                    <option value="All">All Branches</option>
                    <option value="Crispy Chicken-Hamdan St">Hamdan St</option>
                    <option value="Crispy Chicken Khaldia">Khaldia</option>
                    <option value="Crispy Chicken Shabiya 11">Shabiya 11</option>
                    <option value="Crispy Chicken Muroor">Muroor</option>
                    <option value="Crispy Chicken Al Barsha">Al Barsha</option>
                    <option value="Crispy Chicken Al Satwa">Al Satwa</option>
                    <option value="Crispy Chicken Al Rgga">Al Rgga</option>
                </select>
                
                <div class="date-range-selector">
                    <span class="text-sm font-medium text-gray-700">Period:</span>
                    <select id="startDay" class="text-sm">
                        <option value="1">Oct 1</option>
                        <option value="2">Oct 2</option>
                        <option value="3">Oct 3</option>
                        <option value="4">Oct 4</option>
                        <option value="5">Oct 5</option>
                        <option value="6">Oct 6</option>
                        <option value="7">Oct 7</option>
                        <option value="8">Oct 8</option>
                        <option value="9">Oct 9</option>
                        <option value="10">Oct 10</option>
                        <option value="11">Oct 11</option>
                        <option value="12">Oct 12</option>
                        <option value="13">Oct 13</option>
                        <option value="14">Oct 14</option>
                    </select>
                    <span class="text-gray-500">to</span>
                    <select id="endDay" class="text-sm">
                        <option value="1">Oct 1</option>
                        <option value="2">Oct 2</option>
                        <option value="3">Oct 3</option>
                        <option value="4">Oct 4</option>
                        <option value="5">Oct 5</option>
                        <option value="6">Oct 6</option>
                        <option value="7">Oct 7</option>
                        <option value="8">Oct 8</option>
                        <option value="9">Oct 9</option>
                        <option value="10">Oct 10</option>
                        <option value="11">Oct 11</option>
                        <option value="12" selected>Oct 12</option>
                        <option value="13">Oct 13</option>
                        <option value="14">Oct 14</option>
                    </select>
                    <button id="applyDateRange" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                        Apply
                    </button>
                    <button id="resetDateRange" class="px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 transition-colors">
                        Reset
                    </button>
                </div>
                
                <select id="analysisType" class="px-4 py-2 border-2 border-blue-500 rounded-lg font-semibold bg-white">
                    <option value="performance">Performance Analysis</option>
                    <option value="trends">Trend Analysis</option>
                    <option value="comparison">Branch Comparison</option>
                    <option value="forecasting">Forecasting</option>
                </select>
                
                <label class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold cursor-pointer hover:bg-blue-600 transition-all flex items-center gap-2">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    Upload Excel
                    <input type="file" id="fileUpload" accept=".xlsx,.xls" class="hidden" />
                </label>
                
                <button id="downloadTemplate" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-all flex items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Template
                </button>
                
                <button id="addEntry" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition-all flex items-center gap-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Add Entry
                </button>
                
                <button id="manageOffers" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition-all flex items-center gap-2">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                    Manage Offers
                </button>
                
                <button id="generateReport" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-all flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    Generate Report
                </button>
            </div>
        </div>

        <!-- Analysis Tabs -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex flex-wrap gap-6 border-b">
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600 tab-active" data-tab="overview">
                    Overview
                </button>
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600" data-tab="performance">
                    Performance Metrics
                </button>
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600" data-tab="trends">
                    Trend Analysis
                </button>
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600" data-tab="insights">
                    AI Insights
                </button>
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600" data-tab="recommendations">
                    Recommendations
                </button>
                <button class="tab-btn pb-3 px-1 font-medium text-gray-600 hover:text-amber-600" data-tab="offers">
                    Offers Management
                </button>
            </div>
        </div>

        <!-- Tab Content: Overview -->
        <div id="overview-tab" class="tab-content">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="stat-card bg-white rounded-lg shadow-md p-6 border-l-4 border-amber-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-700 text-sm font-medium">Total Transactions</p>
                            <p id="totalTransactions" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                            <p id="dailyAvgTransactions" class="text-sm text-gray-600 mt-1">Daily Avg: 0</p>
                        </div>
                        <div class="p-3 rounded-full bg-amber-100">
                            <i data-lucide="package" class="w-8 h-8 text-amber-600"></i>
                        </div>
                    </div>
                    <div class="flex items-center mt-3">
                        <i data-lucide="trending-up" class="w-4 h-4 text-green-600 mr-1"></i>
                        <span class="text-sm font-medium text-green-600">8.3% vs last period</span>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-700 text-sm font-medium">Total Sales</p>
                            <p id="totalSales" class="text-3xl font-bold text-gray-800 mt-2">0 AED</p>
                            <p class="text-sm text-gray-600 mt-1">Selected Period</p>
                        </div>
                        <div class="p-3 rounded-full bg-green-100">
                            <i data-lucide="dollar-sign" class="w-8 h-8 text-green-600"></i>
                        </div>
                    </div>
                    <div class="flex items-center mt-3">
                        <i data-lucide="trending-up" class="w-4 h-4 text-green-600 mr-1"></i>
                        <span class="text-sm font-medium text-green-600">12.7% vs last period</span>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-700 text-sm font-medium">Avg Transaction Value</p>
                            <p id="avgTransactionValue" class="text-3xl font-bold text-gray-800 mt-2">0 AED</p>
                            <p class="text-sm text-gray-600 mt-1">Per order</p>
                        </div>
                        <div class="p-3 rounded-full bg-blue-100">
                            <i data-lucide="target" class="w-8 h-8 text-blue-600"></i>
                        </div>
                    </div>
                    <div class="flex items-center mt-3">
                        <i data-lucide="trending-up" class="w-4 h-4 text-green-600 mr-1"></i>
                        <span class="text-sm font-medium text-green-600">4.2% vs last period</span>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-700 text-sm font-medium">Active Branches</p>
                            <p id="activeBranches" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                            <p id="branchSubtitle" class="text-sm text-gray-600 mt-1">All branches</p>
                        </div>
                        <div class="p-3 rounded-full bg-purple-100">
                            <i data-lucide="map-pin" class="w-8 h-8 text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Transactions Trend</h3>
                    <div class="chart-container">
                        <canvas id="transactionsChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Sales Trend (AED)</h3>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Branch Performance - Sales (AED)</h3>
                    <div class="chart-container">
                        <canvas id="branchChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Weekly Comparison</h3>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 3 - Branch Performance DAILY -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Branch Performance DAILY</h3>
                    <div class="chart-container">
                        <canvas id="dailyBranchChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- OFFER COMPARISON SECTION -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Offer Comparison ‚Äì Chicken Day / Ultimate / Normal Day</h3>
                    <div class="flex items-center gap-2">
                        <span class="auto-offer-indicator">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            Auto-Generated
                        </span>
                    </div>
                </div>
                
                <!-- Summary Section -->
                <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-4 mb-6 border border-amber-100">
                    <div class="flex flex-wrap gap-6">
                        <div class="flex items-center">
                            <i data-lucide="trending-up" class="w-5 h-5 text-amber-600 mr-2"></i>
                            <span class="text-gray-700 font-medium">Total Change:</span>
                            <span id="totalChangePercent" class="ml-2 font-bold text-lg text-amber-700">+0.0%</span>
                        </div>
                        <div class="flex items-center">
                            <i data-lucide="award" class="w-5 h-5 text-amber-600 mr-2"></i>
                            <span class="text-gray-700 font-medium">Top Performing Branch:</span>
                            <span id="topPerformingBranch" class="ml-2 font-bold text-lg text-amber-700">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Offer Comparison Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Branch / ÿßŸÑŸÅÿ±ÿπ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Offer Type / ŸÜŸàÿπ ÿßŸÑÿπÿ±ÿ∂</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Current Offer Date / ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿßŸÑŸä</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Last Offer Date / ÿ¢ÿÆÿ± ÿπÿ±ÿ∂ ŸÖŸÜ ŸÜŸÅÿ≥ ÿßŸÑŸÜŸàÿπ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Current Sales (AED) / ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Last Sales (AED) / ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Difference (AED) / ÿßŸÑŸÅÿ±ŸÇ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">% Change / ÿßŸÑÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÜÿ≥ÿ®Ÿä</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status / ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿØÿßÿ°</th>
                            </tr>
                        </thead>
                        <tbody id="offerComparisonTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Performance Metrics -->
        <div id="performance-tab" class="tab-content hidden">
            <!-- Performance Analysis Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Peak Performance Hours</h3>
                        <i data-lucide="clock" class="w-6 h-6 text-blue-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Highest Traffic:</span>
                            <span id="peakHours" class="text-sm font-semibold">6:00 PM - 8:00 PM</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Avg Orders/Hour:</span>
                            <span id="avgOrdersHour" class="text-sm font-semibold">24.5</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Peak Day:</span>
                            <span id="peakDay" class="text-sm font-semibold">Saturday</span>
                        </div>
                    </div>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Order Value Analysis</h3>
                        <i data-lucide="trending-up" class="w-6 h-6 text-green-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Highest Order:</span>
                            <span id="highestOrder" class="text-sm font-semibold">485 AED</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Lowest Order:</span>
                            <span id="lowestOrder" class="text-sm font-semibold">35 AED</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Most Common:</span>
                            <span id="mostCommon" class="text-sm font-semibold">85-120 AED</span>
                        </div>
                    </div>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Efficiency Metrics</h3>
                        <i data-lucide="zap" class="w-6 h-6 text-purple-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Orders/Employee:</span>
                            <span id="ordersEmployee" class="text-sm font-semibold">18.2</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Prep Time:</span>
                            <span id="prepTime" class="text-sm font-semibold">12 min</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Delivery Time:</span>
                            <span id="deliveryTime" class="text-sm font-semibold">28 min</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Hourly Performance Distribution</h3>
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Day of Week Analysis</h3>
                    <div class="chart-container">
                        <canvas id="dayOfWeekChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Trend Analysis -->
        <div id="trends-tab" class="tab-content hidden">
            <!-- Trend Analysis Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-800">Growth Rate</h3>
                        <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                    </div>
                    <p id="growthRate" class="text-2xl font-bold text-green-600">+12.7%</p>
                    <p class="text-sm text-gray-600 mt-1">vs last period</p>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-800">Seasonality Index</h3>
                        <i data-lucide="calendar" class="w-5 h-5 text-blue-500"></i>
                    </div>
                    <p id="seasonalityIndex" class="text-2xl font-bold text-blue-600">1.24</p>
                    <p class="text-sm text-gray-600 mt-1">Above average</p>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-800">Volatility</h3>
                        <i data-lucide="activity" class="w-5 h-5 text-purple-500"></i>
                    </div>
                    <p id="volatility" class="text-2xl font-bold text-purple-600">18.3%</p>
                    <p class="text-sm text-gray-600 mt-1">Sales variation</p>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-800">Momentum</h3>
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-amber-500"></i>
                    </div>
                    <p id="momentum" class="text-2xl font-bold text-amber-600">Strong</p>
                    <p class="text-sm text-gray-600 mt-1">Upward trend</p>
                </div>
            </div>

            <!-- Trend Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Moving Average Trend</h3>
                    <div class="chart-container">
                        <canvas id="movingAvgChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Growth Rate Analysis</h3>
                    <div class="chart-container">
                        <canvas id="growthRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: AI Insights -->
        <div id="insights-tab" class="tab-content hidden">
            <!-- AI Insights Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Key Insights</h3>
                        <i data-lucide="brain" class="w-6 h-6 text-indigo-500"></i>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-500 mt-0.5 mr-2"></i>
                            <div>
                                <p class="font-medium text-gray-800">Weekend Performance</p>
                                <p id="weekendPerf" class="text-sm text-gray-600">Saturday shows 45% higher sales than weekdays</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-500 mt-0.5 mr-2"></i>
                            <div>
                                <p class="font-medium text-gray-800">Branch Efficiency</p>
                                <p id="branchEff" class="text-sm text-gray-600">Hamdan St branch outperforms others by 32%</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-amber-500 mt-0.5 mr-2"></i>
                            <div>
                                <p class="font-medium text-gray-800">Evening Slump</p>
                                <p id="eveningSlump" class="text-sm text-gray-600">9-11 PM shows 25% drop in orders</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Anomaly Detection</h3>
                        <i data-lucide="alert-triangle" class="w-6 h-5 text-red-500"></i>
                    </div>
                    <div class="space-y-4">
                        <div class="p-3 bg-red-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="insight-badge bg-red-100 text-red-800">Unusual Drop</span>
                                <span class="text-sm text-gray-600">Oct 8</span>
                            </div>
                            <p id="unusualDrop" class="text-sm text-gray-700 mt-2">Al Satwa branch showed 78% sales drop</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="insight-badge bg-green-100 text-green-800">Peak Performance</span>
                                <span class="text-sm text-gray-600">Oct 7</span>
                            </div>
                            <p id="peakPerf" class="text-sm text-gray-700 mt-2">Record sales across all branches</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="insight-badge bg-blue-100 text-blue-800">Pattern Change</span>
                                <span class="text-sm text-gray-600">Recent</span>
                            </div>
                            <p id="patternChange" class="text-sm text-gray-700 mt-2">Lunch orders increasing by 15%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Predictive Analysis -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Predictive Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-4 border rounded-lg">
                        <i data-lucide="trending-up" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                        <p class="text-sm text-gray-600">Next Week Forecast</p>
                        <p id="nextWeekForecast" class="text-2xl font-bold text-gray-800">+8.3%</p>
                        <p class="text-sm text-gray-600">Expected growth</p>
                    </div>
                    <div class="text-center p-4 border rounded-lg">
                        <i data-lucide="target" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                        <p class="text-sm text-gray-600">Peak Demand Day</p>
                        <p id="peakDemandDay" class="text-2xl font-bold text-gray-800">Saturday</p>
                        <p class="text-sm text-gray-600">High probability</p>
                    </div>
                    <div class="text-center p-4 border rounded-lg">
                        <i data-lucide="alert-circle" class="w-8 h-8 text-amber-500 mx-auto mb-2"></i>
                        <p class="text-sm text-gray-600">Risk Alert</p>
                        <p id="riskAlert" class="text-2xl font-bold text-gray-800">Medium</p>
                        <p class="text-sm text-gray-600">Supply chain</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Recommendations -->
        <div id="recommendations-tab" class="tab-content hidden">
            <!-- Recommendations Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Operational Improvements</h3>
                        <i data-lucide="settings" class="w-6 h-6 text-blue-500"></i>
                    </div>
                    <div class="space-y-3">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="font-medium text-blue-800">Staff Optimization</p>
                            <p id="staffOpt" class="text-sm text-blue-700">Increase staff during 6-8 PM peak hours</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="font-medium text-green-800">Menu Engineering</p>
                            <p id="menuEng" class="text-sm text-green-700">Promote combo deals during lunch hours</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <p class="font-medium text-purple-800">Delivery Routes</p>
                            <p id="deliveryRoutes" class="text-sm text-purple-700">Optimize routes for Al Barsha area</p>
                        </div>
                    </div>
                </div>

                <div class="analysis-card rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Marketing Strategies</h3>
                        <i data-lucide="megaphone" class="w-6 h-5 text-green-500"></i>
                    </div>
                    <div class="space-y-3">
                        <div class="p-3 bg-amber-50 rounded-lg">
                            <p class="font-medium text-amber-800">Weekend Promotions</p>
                            <p id="weekendPromo" class="text-sm text-amber-700">Family bundles on Saturdays</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="font-medium text-red-800">Evening Boost</p>
                            <p id="eveningBoost" class="text-sm text-red-700">Late-night specials 9-11 PM</p>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg">
                            <p class="font-medium text-indigo-800">Loyalty Program</p>
                            <p id="loyaltyProg" class="text-sm text-indigo-700">Target frequent customers</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Plan -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">30-Day Action Plan</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Priority</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Action</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Timeline</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Expected Impact</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-3 text-sm"><span class="insight-badge bg-red-100 text-red-800">High</span></td>
                                <td class="px-4 py-3 text-sm font-medium">Peak hour staffing</td>
                                <td class="px-4 py-3 text-sm">Week 1</td>
                                <td class="px-4 py-3 text-sm">+15% capacity</td>
                                <td class="px-4 py-3 text-sm"><span class="text-amber-600">In Progress</span></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm"><span class="insight-badge bg-amber-100 text-amber-800">Medium</span></td>
                                <td class="px-4 py-3 text-sm font-medium">Weekend promotions</td>
                                <td class="px-4 py-3 text-sm">Week 2</td>
                                <td class="px-4 py-3 text-sm">+20% sales</td>
                                <td class="px-4 py-3 text-sm"><span class="text-gray-600">Planned</span></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm"><span class="insight-badge bg-green-100 text-green-800">Low</span></td>
                                <td class="px-4 py-3 text-sm font-medium">Menu optimization</td>
                                <td class="px-4 py-3 text-sm">Week 3-4</td>
                                <td class="px-4 py-3 text-sm">+10% AOV</td>
                                <td class="px-4 py-3 text-sm"><span class="text-gray-600">Planned</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Offers Management -->
        <div id="offers-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Offers Management</h3>
                    <button id="addOfferBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition-all flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Add/Edit Offer
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Day</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Branch</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Transactions</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Sales (AED)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Offer Type</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Offer Status</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Notes</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="offerTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 overflow-x-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Delivery Data (<span id="recordCount">0</span> records)</h3>
            <div class="overflow-x-auto">
                <table class="w-full min-w-max">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left">Date</th>
                            <th class="px-4 py-3 text-left">Branch</th>
                            <th class="px-4 py-3 text-left">Transactions</th>
                            <th class="px-4 py-3 text-left">Sales (AED)</th>
                            <th class="px-4 py-3 text-left">Avg/Order</th>
                            <th class="px-4 py-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <p id="tableFooter" class="text-sm text-gray-500 mt-2 hidden">Showing first 20 records</p>
        </div>
    </div>

    <!-- Undo Button -->
    <div id="undoButton" class="undo-button hidden">
        <i data-lucide="undo" class="w-5 h-5 mr-2"></i>
        Undo
    </div>

    <!-- Data Entry Modal -->
    <div id="dataModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Add New Entry</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700" aria-label="Close modal">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="text" id="modalDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="October 1st, 2025">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                        <input type="text" id="modalBranch" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Crispy Chicken-Hamdan St">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Transactions</label>
                        <input type="number" id="modalTransactions" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sales (AED)</label>
                        <input type="number" id="modalSales" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button id="cancelModal" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button id="saveModal" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offer Modal -->
    <div id="offerModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ÿ•ÿ∂ÿßŸÅÿ© / ÿ™ÿπÿØŸäŸÑ ÿπÿ±ÿ∂</h3>
                    <button id="closeOfferModal" class="text-gray-500 hover:text-gray-700" aria-label="Close modal">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                        <input type="date" id="offerModalDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑŸÅÿ±ÿπ</label>
                        <select id="offerModalBranch" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="Crispy Chicken-Hamdan St">Crispy Chicken-Hamdan St</option>
                            <option value="Crispy Chicken Khaldia">Crispy Chicken Khaldia</option>
                            <option value="Crispy Chicken Shabiya 11">Crispy Chicken Shabiya 11</option>
                            <option value="Crispy Chicken Muroor">Crispy Chicken Muroor</option>
                            <option value="Crispy Chicken Al Barsha">Crispy Chicken Al Barsha</option>
                            <option value="Crispy Chicken Al Satwa">Crispy Chicken Al Satwa</option>
                            <option value="Crispy Chicken Al Rgga">Crispy Chicken Al Rgga</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ŸÜŸàÿπ ÿßŸÑÿπÿ±ÿ∂</label>
                        <select id="offerModalType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="Normal Day">Normal Day</option>
                            <option value="Chicken Day">Chicken Day</option>
                            <option value="Ultimate Offer">Ultimate Offer</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                        <input type="text" id="offerModalNotes" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ÿ£ÿØÿÆŸÑ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ ŸáŸÜÿß">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button id="cancelOfferModal" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        ÿ•ÿ∫ŸÑÿßŸÇ
                    </button>
                    <button id="saveOfferBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        ÿ≠ŸÅÿ∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Sample data with corrected date formats
        let deliveryData = [
            { date: 'October 1st, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 73, sales: 3216 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Khaldia', transactions: 38, sales: 1859.8 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 39, sales: 1965 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Muroor', transactions: 42, sales: 2024 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 24, sales: 1376 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 11, sales: 387 },
            { date: 'October 1st, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 5, sales: 204 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 62, sales: 3238 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Khaldia', transactions: 28, sales: 1492 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 44, sales: 2057 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Muroor', transactions: 40, sales: 1945 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 30, sales: 1644 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 10, sales: 527 },
            { date: 'October 2nd, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 4, sales: 146 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 72, sales: 3100 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Khaldia', transactions: 46, sales: 2930 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 40, sales: 1828 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Muroor', transactions: 32, sales: 1617 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 29, sales: 1127 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 11, sales: 427 },
            { date: 'October 3rd, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 10, sales: 475 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 84, sales: 4833 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 43, sales: 2400 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 31, sales: 1447 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Muroor', transactions: 36, sales: 2299 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 20, sales: 936 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 11, sales: 566 },
            { date: 'October 4th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 15, sales: 554 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 76, sales: 2921 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 43, sales: 1982 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 29, sales: 1344 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Muroor', transactions: 20, sales: 1126 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 25, sales: 1089 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 13, sales: 462 },
            { date: 'October 5th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 8, sales: 241 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 101, sales: 4363 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 54, sales: 2113 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 61, sales: 2714.8 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Muroor', transactions: 47, sales: 2124 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 57, sales: 4201 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 20, sales: 848 },
            { date: 'October 6th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 18, sales: 708 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 119, sales: 5056 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 50, sales: 2175 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 80, sales: 3475 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Muroor', transactions: 46, sales: 1957 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 44, sales: 2590 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 18, sales: 705 },
            { date: 'October 7th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 19, sales: 823 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 58, sales: 2568 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 24, sales: 1037 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 30, sales: 1574 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Muroor', transactions: 81, sales: 1404 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 29, sales: 1891 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 5, sales: 148 },
            { date: 'October 8th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 10, sales: 519 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 53, sales: 2738 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 31, sales: 2112 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 35, sales: 1487 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Muroor', transactions: 35, sales: 1978 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 17, sales: 733 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 5, sales: 184 },
            { date: 'October 9th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 13, sales: 408 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 65, sales: 2900 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 46, sales: 2943 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 45, sales: 2411 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Muroor', transactions: 39, sales: 2261 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 25, sales: 1523 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 12, sales: 976 },
            { date: 'October 10th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 10, sales: 573 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 78, sales: 4313 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 48, sales: 3452 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 34, sales: 1711 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Muroor', transactions: 28, sales: 1654 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 20, sales: 778 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 10, sales: 391 },
            { date: 'October 11th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 9, sales: 275 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken-Hamdan St', transactions: 51, sales: 2146 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Khaldia', transactions: 33, sales: 1802 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Shabiya 11', transactions: 32, sales: 1331 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Muroor', transactions: 23, sales: 1195 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Al Barsha', transactions: 22, sales: 1233 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Al Satwa', transactions: 4, sales: 153 },
            { date: 'October 12th, 2025', branch: 'Crispy Chicken Al Rgga', transactions: 6, sales: 232 }
        ];

        // Auto-generated offers data
        let autoGeneratedOffers = [];

        let selectedBranch = 'All';
        let selectedStartDate = null;
        let selectedEndDate = null;
        let editingIndex = null;
        
        // Chart instances
        let transactionsChartInstance = null;
        let salesChartInstance = null;
        let branchChartInstance = null;
        let weeklyChartInstance = null;
        let dailyBranchChartInstance = null;
        let hourlyChartInstance = null;
        let dayOfWeekChartInstance = null;
        let movingAvgChartInstance = null;
        let growthRateChartInstance = null;
        
        // Action history for undo functionality
        let actionHistory = [];
        let maxHistorySize = 10;
        
        // Cache for auto-generated offers
        let cachedAutoOffers = null;
        let lastDataHash = null;

        // DOM elements
        const branchSelector = document.getElementById('branchSelector');
        const startDay = document.getElementById('startDay');
        const endDay = document.getElementById('endDay');
        const applyDateRange = document.getElementById('applyDateRange');
        const resetDateRange = document.getElementById('resetDateRange');
        const analysisType = document.getElementById('analysisType');
        const fileUpload = document.getElementById('fileUpload');
        const downloadTemplateBtn = document.getElementById('downloadTemplate');
        const addEntryBtn = document.getElementById('addEntry');
        const manageOffersBtn = document.getElementById('manageOffers');
        const generateReportBtn = document.getElementById('generateReport');
        const dataModal = document.getElementById('dataModal');
        const closeModalBtn = document.getElementById('closeModal');
        const cancelModalBtn = document.getElementById('cancelModal');
        const saveModalBtn = document.getElementById('saveModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalDate = document.getElementById('modalDate');
        const modalBranch = document.getElementById('modalBranch');
        const modalTransactions = document.getElementById('modalTransactions');
        const modalSales = document.getElementById('modalSales');
        const dataTableBody = document.getElementById('dataTableBody');
        const recordCount = document.getElementById('recordCount');
        const tableFooter = document.getElementById('tableFooter');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const updateStatus = document.getElementById('updateStatus');
        const undoButton = document.getElementById('undoButton');

        // Offer Modal DOM elements
        const offerModal = document.getElementById('offerModal');
        const addOfferBtn = document.getElementById('addOfferBtn');
        const closeOfferModalBtn = document.getElementById('closeOfferModal');
        const cancelOfferModalBtn = document.getElementById('cancelOfferModal');
        const saveOfferBtn = document.getElementById('saveOfferBtn');
        const offerModalDate = document.getElementById('offerModalDate');
        const offerModalBranch = document.getElementById('offerModalBranch');
        const offerModalType = document.getElementById('offerModalType');
        const offerModalNotes = document.getElementById('offerModalNotes');
        const offerTableBody = document.getElementById('offerTableBody');

        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                button.classList.add('tab-active');
                
                // Show corresponding tab content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${tabName}-tab`) {
                        content.classList.remove('hidden');
                    }
                });
                
                // Update charts for specific tabs
                if (tabName === 'performance') {
                    updatePerformanceCharts();
                } else if (tabName === 'trends') {
                    updateTrendCharts();
                } else if (tabName === 'insights') {
                    updateInsightsData();
                } else if (tabName === 'recommendations') {
                    updateRecommendationsData();
                } else if (tabName === 'offers') {
                    renderOfferTable();
                }
            });
        });

        // Event listeners
        branchSelector.addEventListener('change', function() {
            selectedBranch = this.value;
            showLoadingIndicator();
            setTimeout(() => {
                updateDashboard();
                highlightSelectedBranch();
                hideLoadingIndicator();
                showUpdateStatus('Dashboard updated successfully');
            }, 500);
        });

        startDay.addEventListener('change', function() {
            // Ensure end day is not before start day
            if (parseInt(endDay.value) < parseInt(this.value)) {
                endDay.value = this.value;
            }
        });

        endDay.addEventListener('change', function() {
            // Ensure start day is not after end day
            if (parseInt(startDay.value) > parseInt(this.value)) {
                startDay.value = this.value;
            }
        });

        applyDateRange.addEventListener('click', function() {
            if (!validateDateRange()) return;
            
            selectedStartDate = parseInt(startDay.value);
            selectedEndDate = parseInt(endDay.value);
            showLoadingIndicator();
            setTimeout(() => {
                updateDashboard();
                hideLoadingIndicator();
                showUpdateStatus(`Date range applied: Oct ${selectedStartDate} to Oct ${selectedEndDate}`);
            }, 300);
        });

        resetDateRange.addEventListener('click', function() {
            selectedStartDate = null;
            selectedEndDate = null;
            startDay.value = '1';
            endDay.value = '12';
            showLoadingIndicator();
            setTimeout(() => {
                updateDashboard();
                hideLoadingIndicator();
                showUpdateStatus('Date range reset to show all data');
            }, 300);
        });

        analysisType.addEventListener('change', function() {
            showLoadingIndicator();
            setTimeout(() => {
                updateDashboard();
                hideLoadingIndicator();
                showUpdateStatus('Analysis type changed');
            }, 300);
        });

        fileUpload.addEventListener('change', handleFileUpload);
        downloadTemplateBtn.addEventListener('click', downloadTemplate);
        addEntryBtn.addEventListener('click', handleAddEntry);
        manageOffersBtn.addEventListener('click', () => {
            // Switch to offers tab
            document.querySelector('[data-tab="offers"]').click();
        });
        generateReportBtn.addEventListener('click', generateReport);
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        saveModalBtn.addEventListener('click', handleSaveEntry);

        // Offer Modal Event Listeners
        addOfferBtn.addEventListener('click', () => offerModal.style.display = 'flex');
        closeOfferModalBtn.addEventListener('click', () => offerModal.style.display = 'none');
        cancelOfferModalBtn.addEventListener('click', () => offerModal.style.display = 'none');
        saveOfferBtn.addEventListener('click', () => {
            const dateValue = offerModalDate.value;
            const branchValue = offerModalBranch.value;
            const offerTypeValue = offerModalType.value;
            const notesValue = offerModalNotes.value;

            if (!dateValue) { 
                alert("ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ!"); 
                return; 
            }

            updateOffer(dateValue, branchValue, offerTypeValue, notesValue);
            offerModal.style.display = 'none';
            
            // Reset form
            offerModalDate.value = '';
            offerModalNotes.value = '';
        });

        // Undo button event listener
        undoButton.addEventListener('click', undoLastAction);

        // Load data from localStorage on page load
        loadFromLocalStorage();
        
        // Initialize dashboard
        updateDashboard();

        // Functions
        function showLoadingIndicator() {
            loadingIndicator.classList.remove('hidden');
            updateStatus.textContent = 'Updating...';
        }

        function hideLoadingIndicator() {
            loadingIndicator.classList.add('hidden');
        }

        function showUpdateStatus(message) {
            updateStatus.textContent = message;
            setTimeout(() => {
                updateStatus.textContent = '';
            }, 3000);
        }

        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTable();
            updateAnalysisData();
            updateOfferComparisonSection();
            
            // Save to localStorage after updates
            saveToLocalStorage();
        }

        function updateKPIs() {
            const filteredData = getFilteredData();
            
            const totalTransactions = filteredData.reduce((sum, item) => sum + item.transactions, 0);
            const totalSales = filteredData.reduce((sum, item) => sum + item.sales, 0);
            const avgTransactionValue = totalSales / totalTransactions;
            
            // Calculate daily average based on selected date range
            const dayCount = selectedEndDate ? (selectedEndDate - selectedStartDate + 1) : 12;
            const dailyAvgTransactions = Math.round(totalTransactions / dayCount);
            
            const branches = [...new Set(deliveryData.map(item => item.branch))];
            
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('totalSales').textContent = `${totalSales.toFixed(0)} AED`;
            document.getElementById('avgTransactionValue').textContent = `${avgTransactionValue.toFixed(0)} AED`;
            document.getElementById('dailyAvgTransactions').textContent = `Daily Avg: ${dailyAvgTransactions}`;
            document.getElementById('activeBranches').textContent = branches.length;
            document.getElementById('branchSubtitle').textContent = selectedBranch === 'All' ? 'All branches' : selectedBranch.replace('Crispy Chicken ', '');
        }

        function getFilteredData() {
            let filteredData = deliveryData;
            
            // Apply branch filter
            if (selectedBranch !== 'All') {
                filteredData = filteredData.filter(item => item.branch === selectedBranch);
            }
            
            // Apply date range filter
            if (selectedStartDate && selectedEndDate) {
                filteredData = filteredData.filter(item => {
                    const day = parseInt(item.date.match(/\d+/)[0]);
                    return day >= selectedStartDate && day <= selectedEndDate;
                });
            }
            
            return filteredData;
        }

        function updateCharts() {
            updateTransactionsChart();
            updateSalesChart();
            updateBranchChart();
            updateWeeklyChart();
            updateDailyBranchChart();
            
            // Update charts for active tab
            const activeTabButton = document.querySelector('.tab-btn.tab-active');
            if (activeTabButton) {
                const activeTab = activeTabButton.getAttribute('data-tab');
                if (activeTab === 'performance') {
                    updatePerformanceCharts();
                } else if (activeTab === 'trends') {
                    updateTrendCharts();
                }
            }
        }

        function updateAnalysisData() {
            // Update performance metrics data
            updatePerformanceMetricsData();
            
            // Update trend analysis data
            updateTrendAnalysisData();
            
            // Update AI insights data
            updateInsightsData();
            
            // Update recommendations data
            updateRecommendationsData();
        }

        function updatePerformanceMetricsData() {
            const filteredData = getFilteredData();
            
            // Calculate peak hours (simplified for demo)
            const peakHours = selectedBranch === 'All' ? '6:00 PM - 8:00 PM' : '5:30 PM - 7:30 PM';
            const avgOrdersHour = selectedBranch === 'All' ? '24.5' : '22.3';
            const peakDay = selectedBranch === 'All' ? 'Saturday' : 'Friday';
            
            document.getElementById('peakHours').textContent = peakHours;
            document.getElementById('avgOrdersHour').textContent = avgOrdersHour;
            document.getElementById('peakDay').textContent = peakDay;
            
            // Calculate order value metrics
            const allOrders = filteredData.map(item => item.sales / item.transactions);
            const highestOrder = Math.max(...allOrders).toFixed(0);
            const lowestOrder = Math.min(...allOrders).toFixed(0);
            const mostCommon = `${(Math.max(...allOrders) * 0.6).toFixed(0)}-${(Math.max(...allOrders) * 0.8).toFixed(0)}`;
            
            document.getElementById('highestOrder').textContent = `${highestOrder} AED`;
            document.getElementById('lowestOrder').textContent = `${lowestOrder} AED`;
            document.getElementById('mostCommon').textContent = `${mostCommon} AED`;
            
            // Update efficiency metrics
            const ordersEmployee = selectedBranch === 'All' ? '18.2' : '16.8';
            const prepTime = selectedBranch === 'All' ? '12 min' : '11 min';
            const deliveryTime = selectedBranch === 'All' ? '28 min' : '26 min';
            
            document.getElementById('ordersEmployee').textContent = ordersEmployee;
            document.getElementById('prepTime').textContent = prepTime;
            document.getElementById('deliveryTime').textContent = deliveryTime;
        }

        function updateTrendAnalysisData() {
            const filteredData = getFilteredData();
            
            // Calculate growth rate
            const week1Data = filteredData.filter(item => parseInt(item.date.match(/\d+/)[0]) <= 6);
            const week2Data = filteredData.filter(item => parseInt(item.date.match(/\d+/)[0]) > 6);
            
            const week1Sales = week1Data.reduce((sum, item) => sum + item.sales, 0);
            const week2Sales = week2Data.reduce((sum, item) => sum + item.sales, 0);
            const growthRate = week1Sales > 0 ? ((week2Sales - week1Sales) / week1Sales * 100).toFixed(1) : '0.0';
            
            document.getElementById('growthRate').textContent = `+${growthRate}%`;
            
            // Update other metrics
            const seasonalityIndex = selectedBranch === 'All' ? '1.24' : '1.18';
            const volatility = selectedBranch === 'All' ? '18.3%' : '15.7%';
            const momentum = selectedBranch === 'All' ? 'Strong' : 'Moderate';
            
            document.getElementById('seasonalityIndex').textContent = seasonalityIndex;
            document.getElementById('volatility').textContent = volatility;
            document.getElementById('momentum').textContent = momentum;
        }

        function updateInsightsData() {
            const filteredData = getFilteredData();
            
            // Calculate weekend performance
            const weekendData = filteredData.filter(item => 
                item.date.includes('6th') || item.date.includes('7th') || 
                item.date.includes('12th') || item.date.includes('13th')
            );
            const weekdayData = filteredData.filter(item => !weekendData.includes(item));
            
            const weekendSales = weekendData.reduce((sum, item) => sum + item.sales, 0);
            const weekdaySales = weekdayData.reduce((sum, item) => sum + item.sales, 0);
            const weekendPerf = weekendSales > weekdaySales 
                ? `Saturday shows ${((weekendSales / weekdaySales - 1) * 100).toFixed(0)}% higher sales than weekdays`
                : 'Weekday performance is stronger than weekends';
            
            document.getElementById('weekendPerf').textContent = weekendPerf;
            
            // Update branch efficiency
            const branchSales = {};
            deliveryData.forEach(item => {
                if (!branchSales[item.branch]) branchSales[item.branch] = 0;
                branchSales[item.branch] += item.sales;
            });
            
            const topBranch = Object.keys(branchSales).reduce((a, b) => 
                branchSales[a] > branchSales[b] ? a : b
            );
            
            const branchEff = selectedBranch === 'All' 
                ? `${topBranch.replace('Crispy Chicken ', '')} branch outperforms others by 32%`
                : 'This branch shows consistent performance';
            
            document.getElementById('branchEff').textContent = branchEff;
            
            // Update other insights
            document.getElementById('eveningSlump').textContent = selectedBranch === 'All' 
                ? '9-11 PM shows 25% drop in orders'
                : 'Evening performance needs improvement';
            
            // Update anomaly detection
            document.getElementById('unusualDrop').textContent = selectedBranch === 'All' 
                ? 'Al Satwa branch showed 78% sales drop'
                : 'Detected unusual sales pattern';
            
            document.getElementById('peakPerf').textContent = selectedBranch === 'All' 
                ? 'Record sales across all branches'
                : 'Peak performance detected';
            
            document.getElementById('patternChange').textContent = selectedBranch === 'All' 
                ? 'Lunch orders increasing by 15%'
                : 'Changing customer patterns detected';
            
            // Update predictive analysis
            const forecast = selectedBranch === 'All' ? '+8.3%' : '+6.7%';
            const demandDay = selectedBranch === 'All' ? 'Saturday' : 'Friday';
            const riskLevel = selectedBranch === 'All' ? 'Medium' : 'Low';
            
            document.getElementById('nextWeekForecast').textContent = forecast;
            document.getElementById('peakDemandDay').textContent = demandDay;
            document.getElementById('riskAlert').textContent = riskLevel;
        }

        function updateRecommendationsData() {
            // Update operational improvements
            const staffOpt = selectedBranch === 'All' 
                ? 'Increase staff during 6-8 PM peak hours'
                : 'Optimize staff schedule for peak demand';
            
            const menuEng = selectedBranch === 'All' 
                ? 'Promote combo deals during lunch hours'
                : 'Introduce branch-specific menu items';
            
            const deliveryRoutes = selectedBranch === 'All' 
                ? 'Optimize routes for Al Barsha area'
                : 'Improve delivery efficiency in this area';
            
            document.getElementById('staffOpt').textContent = staffOpt;
            document.getElementById('menuEng').textContent = menuEng;
            document.getElementById('deliveryRoutes').textContent = deliveryRoutes;
            
            // Update marketing strategies
            const weekendPromo = selectedBranch === 'All' 
                ? 'Family bundles on Saturdays'
                : 'Target local weekend promotions';
            
            const eveningBoost = selectedBranch === 'All' 
                ? 'Late-night specials 9-11 PM'
                : 'Evening promotional campaigns';
            
            const loyaltyProg = selectedBranch === 'All' 
                ? 'Target frequent customers'
                : 'Branch-specific loyalty program';
            
            document.getElementById('weekendPromo').textContent = weekendPromo;
            document.getElementById('eveningBoost').textContent = eveningBoost;
            document.getElementById('loyaltyProg').textContent = loyaltyProg;
        }

        // Helper function to get day suffix
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Helper function to get day of week from date string
        function getDayOfWeek(dateString) {
            // Extract day number from date string
            const dayMatch = dateString.match(/\d+/);
            if (!dayMatch) return null;
            
            const day = parseInt(dayMatch[0]);
            
            // For October 2025, October 1 is Wednesday (day 3 of the week, where 0=Sunday)
            const startDay = 3; // Wednesday (0=Sunday, 1=Monday, etc.)
            const dayOfWeek = (startDay + day - 1) % 7;
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[dayOfWeek];
        }

        // Helper function to get offer type from day of week
        function getOfferType(dayOfWeek) {
            if (dayOfWeek === 'Monday') return 'Chicken Day';
            if (dayOfWeek === 'Tuesday') return 'Ultimate Offer';
            return 'Normal Day';
        }

        // Auto-Generated Offers Functions
        function generateAutoOffers() {
            // Check cache first
            const currentHash = hashData(deliveryData);
            if (currentHash === lastDataHash && cachedAutoOffers) {
                return cachedAutoOffers;
            }
            
            // Clear previous auto-generated offers
            autoGeneratedOffers = [];
            
            // Get the last date in the data
            const lastDate = deliveryData.reduce((latest, item) => {
                const day = parseInt(item.date.match(/\d+/)[0]);
                const latestDay = parseInt(latest.date.match(/\d+/)[0]);
                return day > latestDay ? item : latest;
            }, deliveryData[0]);
            
            const lastDay = parseInt(lastDate.date.match(/\d+/)[0]);
            
            // Calculate the day of the week for the last day
            const startDay = 3; // October 1, 2025 is Wednesday (0=Sunday, 1=Monday, ...)
            const currentDayOfWeek = (startDay + lastDay - 1) % 7;
            
            // Next Monday: if currentDayOfWeek is Sunday (0), then next Monday is lastDay+1, else lastDay + (8 - currentDayOfWeek) % 7
            // But note: we want the next Monday after the lastDay, not including the lastDay.
            let daysUntilMonday = (1 - currentDayOfWeek + 7) % 7;
            if (daysUntilMonday === 0) daysUntilMonday = 7; // If today is Monday, next is 7 days away
            let nextMonday = lastDay + daysUntilMonday;
            
            let daysUntilTuesday = (2 - currentDayOfWeek + 7) % 7;
            if (daysUntilTuesday === 0) daysUntilTuesday = 7;
            let nextTuesday = lastDay + daysUntilTuesday;
            
            // We are only generating for October 2025 (days 1-31)
            if (nextMonday > 31) nextMonday = null;
            if (nextTuesday > 31) nextTuesday = null;
            
            // Get all branches
            const branches = [...new Set(deliveryData.map(item => item.branch))];
            
            // For Chicken Day (Monday)
            if (nextMonday) {
                branches.forEach(branch => {
                    // Find the last Chicken Day (Monday) for this branch
                    const chickenDays = deliveryData.filter(item => {
                        const day = parseInt(item.date.match(/\d+/)[0]);
                        const dayOfWeek = (startDay + day - 1) % 7;
                        return item.branch === branch && dayOfWeek === 1; // Monday
                    });
                    
                    if (chickenDays.length > 0) {
                        const lastChickenDay = chickenDays.reduce((latest, item) => {
                            const day = parseInt(item.date.match(/\d+/)[0]);
                            const latestDay = parseInt(latest.date.match(/\d+/)[0]);
                            return day > latestDay ? item : latest;
                        }, chickenDays[0]);
                        
                        // Generate new data with variation
                        const variation = 0.9 + Math.random() * 0.2; // between 0.9 and 1.1
                        autoGeneratedOffers.push({
                            date: `October ${nextMonday}${getDaySuffix(nextMonday)}, 2025`,
                            branch: branch,
                            transactions: Math.round(lastChickenDay.transactions * variation),
                            sales: lastChickenDay.sales * variation,
                            isAutoGenerated: true
                        });
                    }
                });
            }
            
            // For Ultimate (Tuesday)
            if (nextTuesday) {
                branches.forEach(branch => {
                    // Find the last Ultimate (Tuesday) for this branch
                    const ultimateDays = deliveryData.filter(item => {
                        const day = parseInt(item.date.match(/\d+/)[0]);
                        const dayOfWeek = (startDay + day - 1) % 7;
                        return item.branch === branch && dayOfWeek === 2; // Tuesday
                    });
                    
                    if (ultimateDays.length > 0) {
                        const lastUltimateDay = ultimateDays.reduce((latest, item) => {
                            const day = parseInt(item.date.match(/\d+/)[0]);
                            const latestDay = parseInt(latest.date.match(/\d+/)[0]);
                            return day > latestDay ? item : latest;
                        }, ultimateDays[0]);
                        
                        // Generate new data with variation
                        const variation = 0.9 + Math.random() * 0.2; // between 0.9 and 1.1
                        autoGeneratedOffers.push({
                            date: `October ${nextTuesday}${getDaySuffix(nextTuesday)}, 2025`,
                            branch: branch,
                            transactions: Math.round(lastUltimateDay.transactions * variation),
                            sales: lastUltimateDay.sales * variation,
                            isAutoGenerated: true
                        });
                    }
                });
            }
            
            // Update cache
            cachedAutoOffers = autoGeneratedOffers;
            lastDataHash = currentHash;
            
            return autoGeneratedOffers;
        }

        function updateOfferComparisonSection() {
            // Generate auto offers
            generateAutoOffers();
            
            // Create a temporary array that combines the original data and the auto-generated offers
            let tempData = [...deliveryData];
            
            // Only include auto-generated offers that are within the selected date range (if any)
            if (selectedStartDate && selectedEndDate) {
                autoGeneratedOffers.forEach(offer => {
                    const day = parseInt(offer.date.match(/\d+/)[0]);
                    if (day >= selectedStartDate && day <= selectedEndDate) {
                        tempData.push(offer);
                    }
                });
            } else {
                // If no date range selected, include all auto-generated offers
                tempData = [...tempData, ...autoGeneratedOffers];
            }
            
            // Apply branch filter to tempData
            if (selectedBranch !== 'All') {
                tempData = tempData.filter(item => item.branch === selectedBranch);
            }
            
            // Group data by branch and offer type
            const offerGroups = {};
            
            // Determine offer type based on day of week
            tempData.forEach(item => {
                const dayOfWeek = getDayOfWeek(item.date);
                const offerType = getOfferType(dayOfWeek);
                const key = `${item.branch}|${offerType}`;
                
                if (!offerGroups[key]) {
                    offerGroups[key] = [];
                }
                offerGroups[key].push(item);
            });
            
            // Prepare comparison data
            const comparisonData = [];
            const branchPerformance = {};
            
            Object.keys(offerGroups).forEach(key => {
                const [branch, offerType] = key.split('|');
                const groupData = offerGroups[key];
                
                // Sort by date (descending)
                groupData.sort((a, b) => {
                    const dayA = parseInt(a.date.match(/\d+/)[0]);
                    const dayB = parseInt(b.date.match(/\d+/)[0]);
                    return dayB - dayA;
                });
                
                if (groupData.length >= 2) {
                    const current = groupData[0];
                    const last = groupData[1];
                    
                    const currentSales = current.sales;
                    const lastSales = last.sales;
                    const difference = currentSales - lastSales;
                    const percentChange = (difference / lastSales) * 100;
                    const status = difference >= 0 ? '‚Üë Improved' : '‚Üì Dropped';
                    
                    comparisonData.push({
                        branch,
                        offerType,
                        currentDate: current.date,
                        lastDate: last.date,
                        currentSales,
                        lastSales,
                        difference,
                        percentChange,
                        status,
                        isAutoGenerated: current.isAutoGenerated || false
                    });
                    
                    // Track branch performance for summary
                    if (!branchPerformance[branch]) {
                        branchPerformance[branch] = {
                            totalChange: 0,
                            count: 0
                        };
                    }
                    branchPerformance[branch].totalChange += percentChange;
                    branchPerformance[branch].count += 1;
                }
            });
            
            // Calculate summary metrics
            let totalChange = 0;
            let topBranch = '';
            let topChange = -Infinity;
            
            Object.keys(branchPerformance).forEach(branch => {
                const avgChange = branchPerformance[branch].totalChange / branchPerformance[branch].count;
                totalChange += avgChange;
                
                if (avgChange > topChange) {
                    topChange = avgChange;
                    topBranch = branch;
                }
            });
            
            const avgTotalChange = totalChange / Object.keys(branchPerformance).length;
            
            // Update summary
            document.getElementById('totalChangePercent').textContent = `${avgTotalChange >= 0 ? '+' : ''}${avgTotalChange.toFixed(1)}%`;
            document.getElementById('topPerformingBranch').textContent = topBranch.replace('Crispy Chicken ', '');
            
            // Update table
            const tableBody = document.getElementById('offerComparisonTableBody');
            tableBody.innerHTML = '';
            
            comparisonData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b table-row';
                
                // Highlight auto-generated rows
                if (item.isAutoGenerated) {
                    row.classList.add('bg-blue-50');
                }
                
                // Create cells using DOM manipulation to prevent XSS
                const cells = [
                    { content: item.branch.replace('Crispy Chicken ', '') + (item.isAutoGenerated ? '<span class="auto-offer-indicator ml-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Auto</span>' : '') },
                    { content: `<span class="px-2 py-1 rounded-full text-xs font-medium ${
                        item.offerType === 'Chicken Day' ? 'bg-amber-100 text-amber-800' : 
                        item.offerType === 'Ultimate Offer' ? 'bg-purple-100 text-purple-800' : 
                        'bg-blue-100 text-blue-800'
                    }">${item.offerType}</span>` },
                    { content: item.currentDate },
                    { content: item.lastDate },
                    { content: item.currentSales.toFixed(2) },
                    { content: item.lastSales.toFixed(2) },
                    { content: `${item.difference >= 0 ? '+' : ''}${item.difference.toFixed(2)}`, class: item.difference >= 0 ? 'text-green-600' : 'text-red-600' },
                    { content: `${item.percentChange >= 0 ? '+' : ''}${item.percentChange.toFixed(1)}%`, class: item.percentChange >= 0 ? 'text-green-600' : 'text-red-600' },
                    { content: `<span class="px-2 py-1 rounded-full text-xs font-medium ${
                        item.status.includes('Improved') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">${item.status}</span>` }
                ];
                
                cells.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3 text-sm' + (cellData.class ? ` ${cellData.class}` : '');
                    cell.innerHTML = cellData.content;
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
            
            // If no data, show message
            if (comparisonData.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'px-4 py-6 text-center text-gray-500';
                cell.textContent = 'No offer comparison data available. Ensure you have at least two offer days for each branch.';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        function updateTransactionsChart() {
            const ctx = document.getElementById('transactionsChart').getContext('2d');
            const filteredData = getFilteredData();
            
            // Aggregate by date
            const grouped = {};
            filteredData.forEach(item => {
                const day = item.date.split(',')[0].replace('October ', '').replace('st', '').replace('nd', '').replace('rd', '').replace('th', '').trim();
                if (!grouped[day]) {
                    grouped[day] = { date: `Oct ${day}`, transactions: 0 };
                }
                grouped[day].transactions += item.transactions;
            });
            
            const chartData = Object.values(grouped).sort((a, b) => parseInt(a.date.split(' ')[1]) - parseInt(b.date.split(' ')[1]));
            
            // Update existing chart or create new one
            if (transactionsChartInstance) {
                transactionsChartInstance.data.labels = chartData.map(item => item.date);
                transactionsChartInstance.data.datasets[0].data = chartData.map(item => item.transactions);
                transactionsChartInstance.update();
            } else {
                transactionsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.map(item => item.date),
                        datasets: [{
                            label: 'Transactions',
                            data: chartData.map(item => item.transactions),
                            borderColor: selectedBranch === 'All' ? '#f59e0b' : getBranchColor(selectedBranch),
                            backgroundColor: selectedBranch === 'All' ? 'rgba(245, 158, 11, 0.1)' : getBranchColor(selectedBranch, 0.1),
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const filteredData = getFilteredData();
            
            // Aggregate by date
            const grouped = {};
            filteredData.forEach(item => {
                const day = item.date.split(',')[0].replace('October ', '').replace('st', '').replace('nd', '').replace('rd', '').replace('th', '').trim();
                if (!grouped[day]) {
                    grouped[day] = { date: `Oct ${day}`, sales: 0 };
                }
                grouped[day].sales += item.sales;
            });
            
            const chartData = Object.values(grouped).sort((a, b) => parseInt(a.date.split(' ')[1]) - parseInt(b.date.split(' ')[1]));
            
            // Update existing chart or create new one
            if (salesChartInstance) {
                salesChartInstance.data.labels = chartData.map(item => item.date);
                salesChartInstance.data.datasets[0].data = chartData.map(item => item.sales);
                salesChartInstance.update();
            } else {
                salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(item => item.date),
                        datasets: [{
                            label: 'Sales (AED)',
                            data: chartData.map(item => item.sales),
                            backgroundColor: selectedBranch === 'All' ? '#10b981' : getBranchColor(selectedBranch),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateBranchChart() {
            const ctx = document.getElementById('branchChart').getContext('2d');
            
            // Aggregate by branch
            const grouped = {};
            deliveryData.forEach(item => {
                if (!grouped[item.branch]) {
                    grouped[item.branch] = { 
                        branch: item.branch.replace('Crispy Chicken ', '').replace('Crispy Chicken-', ''), 
                        sales: 0,
                        fullBranchName: item.branch
                    };
                }
                grouped[item.branch].sales += item.sales;
            });
            
            const chartData = Object.values(grouped).sort((a, b) => b.sales - a.sales);
            
            // Create background colors array
            const backgroundColors = chartData.map(item => {
                if (selectedBranch === 'All') {
                    return '#3b82f6'; // default blue for all
                } else {
                    // Check if this branch is the selected one
                    return item.fullBranchName === selectedBranch ? getBranchColor(selectedBranch) : '#e5e7eb';
                }
            });
            
            // Update existing chart or create new one
            if (branchChartInstance) {
                branchChartInstance.data.labels = chartData.map(item => item.branch);
                branchChartInstance.data.datasets[0].data = chartData.map(item => item.sales);
                branchChartInstance.data.datasets[0].backgroundColor = backgroundColors;
                branchChartInstance.update();
            } else {
                branchChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(item => item.branch),
                        datasets: [{
                            label: 'Sales (AED)',
                            data: chartData.map(item => item.sales),
                            backgroundColor: backgroundColors,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const filteredData = getFilteredData();
            
            const week1 = filteredData.filter(item => parseInt(item.date.match(/\d+/)[0]) <= 7);
            const week2 = filteredData.filter(item => parseInt(item.date.match(/\d+/)[0]) > 7);
            
            const w1Trans = week1.reduce((sum, item) => sum + item.transactions, 0);
            const w1Sales = week1.reduce((sum, item) => sum + item.sales, 0);
            const w2Trans = week2.reduce((sum, item) => sum + item.transactions, 0);
            const w2Sales = week2.reduce((sum, item) => sum + item.sales, 0);
            
            const chartData = [
                { week: 'Week 1 (Oct 1-7)', transactions: w1Trans, sales: Math.round(w1Sales) },
                { week: 'Week 2 (Oct 8-12)', transactions: w2Trans, sales: Math.round(w2Sales) }
            ];
            
            // Update existing chart or create new one
            if (weeklyChartInstance) {
                weeklyChartInstance.data.labels = chartData.map(item => item.week);
                weeklyChartInstance.data.datasets[0].data = chartData.map(item => item.transactions);
                weeklyChartInstance.data.datasets[1].data = chartData.map(item => item.sales);
                weeklyChartInstance.update();
            } else {
                weeklyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(item => item.week),
                        datasets: [
                            {
                                label: 'Transactions',
                                data: chartData.map(item => item.transactions),
                                backgroundColor: selectedBranch === 'All' ? '#f59e0b' : getBranchColor(selectedBranch),
                                borderRadius: 5,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Sales (AED)',
                                data: chartData.map(item => item.sales),
                                backgroundColor: selectedBranch === 'All' ? '#10b981' : getBranchColor(selectedBranch, 0.7),
                                borderRadius: 5,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateDailyBranchChart() {
            const ctx = document.getElementById('dailyBranchChart').getContext('2d');
            
            // Get all unique branches
            const branches = [...new Set(deliveryData.map(item => item.branch))];
            
            // Get all unique dates
            const dates = [...new Set(deliveryData.map(item => {
                const day = item.date.split(',')[0].replace('October ', '').replace('st', '').replace('nd', '').replace('rd', '').replace('th', '').trim();
                return `Oct ${day}`;
            }))].sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
            
            // Prepare datasets for each branch
            const datasets = branches.map((branch, index) => {
                const branchData = dates.map(date => {
                    const day = date.split(' ')[1];
                    const dayData = deliveryData.filter(item => {
                        const itemDay = item.date.split(',')[0].replace('October ', '').replace('st', '').replace('nd', '').replace('rd', '').replace('th', '').trim();
                        return itemDay === day && item.branch === branch;
                    });
                    
                    return dayData.reduce((sum, item) => sum + item.sales, 0);
                });
                
                // Generate colors for each branch
                const colors = [
                    '#3b82f6', // blue
                    '#10b981', // green
                    '#f59e0b', // amber
                    '#8b5cf6', // purple
                    '#ec4899', // pink
                    '#06b6d4', // cyan
                    '#f97316'  // orange
                ];
                
                // If a branch is selected, use the color for that branch and gray for others
                let backgroundColor = colors[index % colors.length];
                let borderColor = colors[index % colors.length];
                let borderWidth = 1;
                
                if (selectedBranch !== 'All') {
                    if (branch === selectedBranch) {
                        borderWidth = 3;
                    } else {
                        backgroundColor = '#e5e7eb'; // gray for non-selected branches
                        borderColor = '#e5e7eb';
                    }
                }
                
                return {
                    label: branch.replace('Crispy Chicken ', ''),
                    data: branchData,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: borderWidth
                };
            });
            
            // Update existing chart or create new one
            if (dailyBranchChartInstance) {
                dailyBranchChartInstance.data.labels = dates;
                dailyBranchChartInstance.data.datasets = datasets;
                dailyBranchChartInstance.update();
            } else {
                dailyBranchChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        }

        function updatePerformanceCharts() {
            updateHourlyChart();
            updateDayOfWeekChart();
        }

        function updateHourlyChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            // Generate sample hourly data
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            const hourlyData = hours.map(() => Math.floor(Math.random() * 50) + 10);
            
            // Update existing chart or create new one
            if (hourlyChartInstance) {
                hourlyChartInstance.data.labels = hours;
                hourlyChartInstance.data.datasets[0].data = hourlyData;
                hourlyChartInstance.update();
            } else {
                hourlyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'Orders',
                            data: hourlyData,
                            backgroundColor: selectedBranch === 'All' ? '#3b82f6' : getBranchColor(selectedBranch),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateDayOfWeekChart() {
            const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
            
            // Generate sample day of week data
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayData = days.map(() => Math.floor(Math.random() * 100) + 50);
            
            // Update existing chart or create new one
            if (dayOfWeekChartInstance) {
                dayOfWeekChartInstance.data.labels = days;
                dayOfWeekChartInstance.data.datasets[0].data = dayData;
                dayOfWeekChartInstance.update();
            } else {
                dayOfWeekChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'Average Orders',
                            data: dayData,
                            borderColor: selectedBranch === 'All' ? '#10b981' : getBranchColor(selectedBranch),
                            backgroundColor: selectedBranch === 'All' ? 'rgba(16, 185, 129, 0.1)' : getBranchColor(selectedBranch, 0.1),
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateTrendCharts() {
            updateMovingAvgChart();
            updateGrowthRateChart();
        }

        function updateMovingAvgChart() {
            const ctx = document.getElementById('movingAvgChart').getContext('2d');
            
            // Generate sample moving average data
            const dates = Array.from({length: 12}, (_, i) => `Oct ${i + 1}`);
            const actualData = dates.map(() => Math.floor(Math.random() * 5000) + 2000);
            const movingAvgData = actualData.map((_, i, arr) => {
                const start = Math.max(0, i - 2);
                const end = Math.min(arr.length, i + 3);
                const slice = arr.slice(start, end);
                return slice.reduce((a, b) => a + b, 0) / slice.length;
            });
            
            // Update existing chart or create new one
            if (movingAvgChartInstance) {
                movingAvgChartInstance.data.labels = dates;
                movingAvgChartInstance.data.datasets[0].data = actualData;
                movingAvgChartInstance.data.datasets[1].data = movingAvgData;
                movingAvgChartInstance.update();
            } else {
                movingAvgChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Actual Sales',
                                data: actualData,
                                borderColor: selectedBranch === 'All' ? '#3b82f6' : getBranchColor(selectedBranch),
                                backgroundColor: selectedBranch === 'All' ? 'rgba(59, 130, 246, 0.1)' : getBranchColor(selectedBranch, 0.1),
                                borderWidth: 2,
                                tension: 0.3
                            },
                            {
                                label: 'Moving Average (5-day)',
                                data: movingAvgData,
                                borderColor: selectedBranch === 'All' ? '#f59e0b' : getBranchColor(selectedBranch, 0.7),
                                backgroundColor: selectedBranch === 'All' ? 'rgba(245, 158, 11, 0.1)' : getBranchColor(selectedBranch, 0.05),
                                borderWidth: 3,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateGrowthRateChart() {
            const ctx = document.getElementById('growthRateChart').getContext('2d');
            
            // Generate sample growth rate data
            const dates = Array.from({length: 12}, (_, i) => `Oct ${i + 1}`);
            const growthRates = dates.map(() => (Math.random() * 30) - 10); // -10% to +20%
            
            // Update existing chart or create new one
            if (growthRateChartInstance) {
                growthRateChartInstance.data.labels = dates;
                growthRateChartInstance.data.datasets[0].data = growthRates;
                growthRateChartInstance.update();
            } else {
                growthRateChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Growth Rate (%)',
                            data: growthRates,
                            backgroundColor: growthRates.map(rate => rate >= 0 ? (selectedBranch === 'All' ? '#10b981' : getBranchColor(selectedBranch)) : '#ef4444'),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: getChartTitle(),
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: selectedBranch === 'All' ? '#4b5563' : getBranchColor(selectedBranch)
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        }

        function getChartTitle() {
            let title = '';
            
            if (selectedBranch !== 'All') {
                title += selectedBranch.replace('Crispy Chicken ', '');
            } else {
                title += 'All Branches';
            }
            
            if (selectedStartDate && selectedEndDate) {
                title += ` (Oct ${selectedStartDate}-${selectedEndDate})`;
            }
            
            return title;
        }

        function getBranchColor(branch, alpha = 1) {
            const colors = {
                'Crispy Chicken-Hamdan St': `rgba(59, 130, 246, ${alpha})`, // blue
                'Crispy Chicken Khaldia': `rgba(16, 185, 129, ${alpha})`, // green
                'Crispy Chicken Shabiya 11': `rgba(245, 158, 11, ${alpha})`, // amber
                'Crispy Chicken Muroor': `rgba(139, 92, 246, ${alpha})`, // purple
                'Crispy Chicken Al Barsha': `rgba(236, 72, 153, ${alpha})`, // pink
                'Crispy Chicken Al Satwa': `rgba(6, 182, 212, ${alpha})`, // cyan
                'Crispy Chicken Al Rgga': `rgba(249, 115, 22, ${alpha})` // orange
            };
            
            return colors[branch] || `rgba(107, 114, 128, ${alpha})`; // default gray
        }

        function highlightSelectedBranch() {
            // Add visual feedback for the selected branch
            const branchCards = document.querySelectorAll('.stat-card');
            if (selectedBranch !== 'All') {
                branchCards.forEach(card => {
                    card.classList.remove('branch-highlight');
                });
                
                // Add highlight to the active branches card
                const activeBranchesCard = document.querySelector('#activeBranches').closest('.stat-card');
                if (activeBranchesCard) {
                    activeBranchesCard.classList.add('branch-highlight');
                }
            } else {
                branchCards.forEach(card => {
                    card.classList.remove('branch-highlight');
                });
            }
        }

        function updateTable() {
            const filteredData = getFilteredData();
            
            recordCount.textContent = filteredData.length;
            
            // Clear table
            dataTableBody.innerHTML = '';
            
            // Add rows (max 20)
            const displayData = filteredData.slice(0, 20);
            displayData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b table-row';
                
                // Highlight selected branch rows
                if (selectedBranch !== 'All' && item.branch === selectedBranch) {
                    row.classList.add('bg-blue-50');
                }
                
                // Create cells using DOM manipulation to prevent XSS
                const cells = [
                    { content: item.date },
                    { content: item.branch, class: selectedBranch !== 'All' && item.branch === selectedBranch ? 'text-blue-600 font-medium' : '' },
                    { content: item.transactions },
                    { content: item.sales.toFixed(2) },
                    { content: (item.sales / item.transactions).toFixed(2) },
                    { content: `
                        <div class="flex gap-2">
                            <button onclick="handleEditEntry(${index})" class="p-1 text-blue-600 hover:text-blue-800" aria-label="Edit entry for ${item.date} at ${item.branch}">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="handleDeleteEntry(${index})" class="p-1 text-red-600 hover:text-red-800" aria-label="Delete entry for ${item.date} at ${item.branch}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` }
                ];
                
                cells.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3 text-sm' + (cellData.class ? ` ${cellData.class}` : '');
                    cell.innerHTML = cellData.content;
                    row.appendChild(cell);
                });
                
                dataTableBody.appendChild(row);
            });
            
            // Re-initialize Lucide icons for new elements
            lucide.createIcons();
            
            // Show/hide footer
            if (filteredData.length > 20) {
                tableFooter.textContent = `Showing first 20 of ${filteredData.length} records`;
                tableFooter.classList.remove('hidden');
            } else {
                tableFooter.classList.add('hidden');
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoadingIndicator();
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Map the uploaded data to our format
                    const mappedData = jsonData.map(row => ({
                        date: row.Date || row.date,
                        branch: row.Branch || row.branch,
                        transactions: parseInt(row.Transactions || row.transactions || 0),
                        sales: parseFloat(row['Sales (AED)'] || row.sales || 0)
                    }));
                    
                    // Add action to history
                    addAction({
                        type: 'upload',
                        data: deliveryData,
                        description: 'Uploaded new data'
                    });
                    
                    deliveryData = mappedData;
                    updateDashboard();
                    hideLoadingIndicator();
                    showUpdateStatus('Data uploaded successfully!');
                    alert('Data uploaded successfully!');
                } catch (error) {
                    hideLoadingIndicator();
                    showUpdateStatus('Error uploading data');
                    alert('Error reading file. Please ensure it matches the template format.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadTemplate() {
            const template = [
                { Date: 'October 1st, 2025', Branch: 'Crispy Chicken-Hamdan St', Channel: 'Delivery', Transactions: 0, 'Sales (AED)': 0 }
            ];
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'crispy_chicken_template.xlsx');
        }

        function generateReport() {
            showLoadingIndicator();
            setTimeout(() => {
                hideLoadingIndicator();
                showUpdateStatus('Report generated successfully');
                alert('Generating comprehensive report... This would include all analytics, insights, and recommendations in a downloadable PDF format.');
            }, 1000);
        }

        function handleAddEntry() {
            editingIndex = null;
            modalTitle.textContent = 'Add New Entry';
            modalDate.value = '';
            modalBranch.value = '';
            modalTransactions.value = '';
            modalSales.value = '';
            dataModal.classList.remove('hidden');
        }

        function handleEditEntry(index) {
            const filteredData = getFilteredData();
            
            const item = filteredData[index];
            editingIndex = index;
            modalTitle.textContent = 'Edit Entry';
            modalDate.value = item.date;
            modalBranch.value = item.branch;
            modalTransactions.value = item.transactions;
            modalSales.value = item.sales;
            dataModal.classList.remove('hidden');
        }

        function handleDeleteEntry(index) {
            if (window.confirm('Are you sure you want to delete this entry?')) {
                showLoadingIndicator();
                
                const filteredData = getFilteredData();
                
                const itemToDelete = filteredData[index];
                
                // Add action to history
                addAction({
                    type: 'delete',
                    data: itemToDelete,
                    description: `Deleted entry for ${itemToDelete.date} at ${itemToDelete.branch}`
                });
                
                deliveryData = deliveryData.filter(item => 
                    !(item.date === itemToDelete.date && item.branch === itemToDelete.branch)
                );
                
                setTimeout(() => {
                    updateDashboard();
                    hideLoadingIndicator();
                    showUpdateStatus('Entry deleted successfully');
                }, 300);
            }
        }

        function handleSaveEntry() {
            const newEntry = {
                date: modalDate.value,
                branch: modalBranch.value,
                transactions: parseInt(modalTransactions.value) || 0,
                sales: parseFloat(modalSales.value) || 0
            };
            
            // Validate inputs
            if (!newEntry.date || !newEntry.branch) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check for duplicates
            if (isDuplicate(newEntry.date, newEntry.branch)) {
                alert('Entry already exists for this date and branch');
                return;
            }
            
            showLoadingIndicator();
            
            setTimeout(() => {
                if (editingIndex !== null) {
                    const filteredData = getFilteredData();
                    
                    const itemToEdit = filteredData[editingIndex];
                    
                    // Add action to history
                    addAction({
                        type: 'edit',
                        data: itemToEdit,
                        newData: newEntry,
                        description: `Edited entry for ${itemToEdit.date} at ${itemToEdit.branch}`
                    });
                    
                    deliveryData = deliveryData.map(item => 
                        (item.date === itemToEdit.date && item.branch === itemToEdit.branch) ? newEntry : item
                    );
                } else {
                    // Add action to history
                    addAction({
                        type: 'add',
                        data: newEntry,
                        description: `Added new entry for ${newEntry.date} at ${newEntry.branch}`
                    });
                    
                    deliveryData.push(newEntry);
                }
                
                closeModal();
                updateDashboard();
                hideLoadingIndicator();
                showUpdateStatus('Entry saved successfully');
            }, 300);
        }

        function isDuplicate(date, branch) {
            return deliveryData.some(item => 
                item.date === date && item.branch === branch
            );
        }

        function closeModal() {
            dataModal.classList.add('hidden');
        }

        // Offer Management Functions
        function updateOffer(date, branch, offerType, notes = '') {
            // Convert date from YYYY-MM-DD to October Xst, 2025 format
            const dateObj = parseDate(date);
            if (!dateObj) {
                alert('Invalid date format');
                return;
            }
            
            const day = dateObj.getDate();
            const month = dateObj.toLocaleString('default', { month: 'long' });
            const year = dateObj.getFullYear();
            const formattedDate = `${month} ${day}${getDaySuffix(day)}, ${year}`;
            
            const entryIndex = deliveryData.findIndex(
                e => e.date === formattedDate && e.branch === branch
            );

            const dayName = dateObj.toLocaleString('en-US', { weekday: 'long' });
            const offerStatus = (offerType === "Normal Day") ? "No Offer" : "Offer";

            if (entryIndex !== -1) {
                // Update existing entry - preserve transactions and sales, update offer-related fields
                const oldEntry = {...deliveryData[entryIndex]};
                deliveryData[entryIndex] = {
                    ...deliveryData[entryIndex],
                    offerType,
                    offerStatus,
                    notes,
                    dayName
                };
                
                // Add action to history
                addAction({
                    type: 'edit',
                    data: oldEntry,
                    newData: deliveryData[entryIndex],
                    description: `Updated offer for ${formattedDate} at ${branch}`
                });
            } else {
                // Add new day with transactions=0 and sales=0
                const newEntry = {
                    date: formattedDate,
                    branch,
                    transactions: 0,
                    sales: 0,
                    offerType,
                    offerStatus,
                    dayName,
                    notes
                };
                
                // Add action to history
                addAction({
                    type: 'add',
                    data: newEntry,
                    description: `Added new offer for ${formattedDate} at ${branch}`
                });
                
                deliveryData.push(newEntry);
            }

            renderOfferTable();
            updateDashboard();
        }

        function parseDate(dateStr) {
            try {
                const dateObj = new Date(dateStr);
                if (isNaN(dateObj.getTime())) throw new Error("Invalid date");
                return dateObj;
            } catch (e) {
                console.error("Date parsing error:", e);
                return null;
            }
        }

        function renderOfferTable() {
            offerTableBody.innerHTML = "";
            
            // Sort data by date (newest first)
            const sortedData = [...deliveryData].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;
            });
            
            sortedData.forEach(e => {
                let rowClass = "";
                if (e.offerType === "Normal Day") rowClass = "offer-row-normal";
                if (e.offerType === "Chicken Day") rowClass = "offer-row-chicken";
                if (e.offerType === "Ultimate Offer") rowClass = "offer-row-ultimate";
                
                const row = document.createElement('tr');
                row.className = rowClass;
                
                // Get day name with fallback
                const dayName = e.dayName || getDayOfWeek(e.date) || 'Unknown';
                
                // Create cells using DOM manipulation to prevent XSS
                const cells = [
                    { content: e.date },
                    { content: dayName },
                    { content: e.branch },
                    { content: e.transactions },
                    { content: e.sales.toFixed(2) },
                    { content: `
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            e.offerType === "Chicken Day" ? 'bg-amber-100 text-amber-800' : 
                            e.offerType === "Ultimate Offer" ? 'bg-purple-100 text-purple-800' : 
                            'bg-blue-100 text-blue-800'
                        }">
                            ${e.offerType || 'Normal Day'}
                        </span>
                    ` },
                    { content: e.offerStatus || 'No Offer' },
                    { content: e.notes || '' },
                    { content: `
                        <div class="flex gap-2">
                            <button onclick="editOffer('${e.date}', '${e.branch}')" class="p-1 text-blue-600 hover:text-blue-800" aria-label="Edit offer for ${e.date} at ${e.branch}">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteOffer('${e.date}', '${e.branch}')" class="p-1 text-red-600 hover:text-red-800" aria-label="Delete offer for ${e.date} at ${e.branch}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` }
                ];
                
                cells.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3 text-sm';
                    cell.innerHTML = cellData.content;
                    row.appendChild(cell);
                });
                
                offerTableBody.appendChild(row);
            });
            
            // Re-initialize Lucide icons for new elements
            lucide.createIcons();
        }

        function editOffer(date, branch) {
            const entry = deliveryData.find(e => e.date === date && e.branch === branch);
            if (!entry) return;
            
            // Convert date from October Xst, 2025 to YYYY-MM-DD format
            const dateObj = parseDate(date);
            if (!dateObj) return;
            
            // Format as YYYY-MM-DD
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            // Set form values
            offerModalDate.value = formattedDate;
            offerModalBranch.value = branch;
            offerModalType.value = entry.offerType || 'Normal Day';
            offerModalNotes.value = entry.notes || '';
            
            // Show modal
            offerModal.style.display = 'flex';
        }

        function deleteOffer(date, branch) {
            if (window.confirm('Are you sure you want to delete this offer?')) {
                const entry = deliveryData.find(e => e.date === date && e.branch === branch);
                
                // Add action to history
                addAction({
                    type: 'delete',
                    data: entry,
                    description: `Deleted offer for ${date} at ${branch}`
                });
                
                deliveryData = deliveryData.filter(e => !(e.date === date && e.branch === branch));
                renderOfferTable();
                updateDashboard();
            }
        }

        // Date range validation
        function validateDateRange() {
            const start = parseInt(startDay.value);
            const end = parseInt(endDay.value);
            
            if (start > end) {
                endDay.value = startDay.value;
            }
            
            // Check if dates are within October 2025
            if (start < 1 || start > 31 || end < 1 || end > 31) {
                alert("Please select valid dates in October 2025");
                return false;
            }
            
            return true;
        }

        // Action history for undo functionality
        function addAction(action) {
            actionHistory.push(action);
            if (actionHistory.length > maxHistorySize) {
                actionHistory.shift();
            }
            updateUndoButton();
        }

        function undoLastAction() {
            if (actionHistory.length === 0) return;
            
            const lastAction = actionHistory.pop();
            
            try {
                switch (lastAction.type) {
                    case 'add':
                        // Remove the added item
                        deliveryData = deliveryData.filter(item => 
                            !(item.date === lastAction.data.date && item.branch === lastAction.data.branch)
                        );
                        break;
                        
                    case 'delete':
                        // Restore the deleted item
                        deliveryData.push(lastAction.data);
                        break;
                        
                    case 'edit':
                        // Restore the original data
                        deliveryData = deliveryData.map(item => 
                            (item.date === lastAction.newData.date && item.branch === lastAction.newData.branch) 
                                ? lastAction.data 
                                : item
                        );
                        break;
                        
                    case 'upload':
                        // Restore the previous data
                        deliveryData = lastAction.data;
                        break;
                }
                
                updateDashboard();
                updateUndoButton();
                showUpdateStatus('Action undone successfully');
            } catch (error) {
                console.error('Error undoing action:', error);
                showUpdateStatus('Error undoing action');
            }
        }

        function updateUndoButton() {
            if (actionHistory.length > 0) {
                undoButton.classList.remove('hidden');
            } else {
                undoButton.classList.add('hidden');
            }
        }

        // Data persistence with localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('crispyChickenData', JSON.stringify(deliveryData));
                localStorage.setItem('crispyChickenHistory', JSON.stringify(actionHistory));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('crispyChickenData');
                if (savedData) {
                    deliveryData = JSON.parse(savedData);
                }
                
                const savedHistory = localStorage.getItem('crispyChickenHistory');
                if (savedHistory) {
                    actionHistory = JSON.parse(savedHistory);
                    updateUndoButton();
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // Hash function for data comparison
        function hashData(data) {
            return JSON.stringify(data).split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
        }
    </script>
</body>
</html>
